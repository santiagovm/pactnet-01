trigger: none

resources:
  webhooks:
  - webhook: test-04-webhook
    connection: test-04-connection

#   webhooks:
#   - webhook: test-01
#     connection: vasquez-house-pactflow
#     filters:
#     - path: consumerPactUri
#       value: not-set

pool:
    vmImage: ubuntu-latest

stages:
- stage: dev
  displayName: dev environment
  jobs:
  - job: test
    variables:
      GIT_COMMIT_SHORT_SHA: value-set-below
    steps:
      - script: |
          sourceVersion=$(Build.SourceVersion)
          echo sourceVersion: $sourceVersion

          shortSha=${sourceVersion:0:7}
          echo shortSha: $shortSha

          echo "##vso[task.setvariable variable=GIT_COMMIT_SHORT_SHA]$shortSha"
        displayName: get commit short sha
      - script: |
          dotnet test provider/Provider.Test/Provider.Test.csproj --configuration Release
        displayName: dotnet test
        env:
          PROVIDER_FOO_API_BASE_URI: http://localhost:9333
          CONSUMER_PACT_URI: ${{parameters.test-04-webhook.consumerPactUri}}
          PACT_BROKER_API_TOKEN: $(pact.broker.api.token)
          GIT_COMMIT_SHORT_SHA: $(GIT_COMMIT_SHORT_SHA)
          CI: true